#!/bin/sh

start() {
    mb start --protofile /etc/mountebank/protocols.json &

    echo 'Waiting for mb to start...'
    sleep 0.5
    until curl -fail -s http://localhost:2525/; do
        sleep 0.1
    done

    (
        cd /etc/mountebank/config.d
        for file in $(ls); do
            curl -i -X POST -H 'Content-Type: application/json' --data @"$file" \
                http://localhost:2525/imposters
        done
    )

    echo 'Started'

    while true; do
        sleep 86400
    done
}

stop() {
    mb stop
}

restart() {
    stop

    while curl -fail -s http://localhost:2525/; do
        sleep 0.1
    done

    start
}

trap EXIT stop
trap HUP restart

start
