#!/usr/bin/env python3

from dataclasses import dataclass
import json
import re
import os

import config

# Input
CONFIG_FILE = '/work/config.{}'

# Outputs
WIRING_FILE = '/work/wiring.env'


def computeEgresses(cmds, cfg, basedir, start, end):
    nextPort = config.portAllocator(start, end)
    for (service, egress) in sorted(cfg['egresses'].items()):
        match egress:
            case [egress, *tail]:
                if tail:
                    raise NotImplementedError(
                        "len(egress) != 1 not supported")

        match egress:
            case str():
                egress = config.dockerExternalURL(egress)
                cmds.proxy(egress, port=nextPort())
            case {'mountebank': mb}:
                # TODO: port?
                cmds.mountebank(service, mb, basedir, port=nextPort())


def generateWiringFile(cfg):
    with open(WIRING_FILE, 'w') as w:
        json.dump({
            'ingress': f"127.0.0.1:10000",
            'egresses': {
                key: f"http://localhost:{cfg['envelope']}/egresses/{key}"
                for key in cfg['egresses']
            }
        }, w, indent=2)


def main():
    (cfg, path) = config.loadAny(CONFIG_FILE)
    match cfg:
        case {'envelope': {'expose': {'first': first, 'last': last}}}:
            pass
        case _:
            first, last = 4200, 4299

    with config.Commands(basePort=first) as cmds:
        computeEgresses(cmds, cfg, config.basedir(path), first+1, last+1)
        generateWiringFile(cfg)

        cmds.watch(path)


if __name__ == '__main__':
    main()
